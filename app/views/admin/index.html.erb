<% content_for :title, "ç®¡ç†ç”»é¢" %>

<div class="container">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ç®¡ç†ç”»é¢</h1>
        <div>
          <span class="me-3">ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: <strong><%= current_user.name %></strong></span>
          <%= link_to "ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹", root_path, class: "btn btn-outline-primary" %>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <h3 class="card-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</h3>
              <p class="card-text">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§è¡¨ç¤ºã€ç·¨é›†ã€å‰Šé™¤ã‚’è¡Œã„ã¾ã™ã€‚</p>
              <div class="d-grid">
                <%= link_to "ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†", users_path, class: "btn btn-primary" %>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <h3 class="card-title">ãƒ¡ãƒ³ã‚¿ãƒ¼ç®¡ç†</h3>
              <p class="card-text">ãƒ¡ãƒ³ã‚¿ãƒ¼ã‚¢ãƒã‚¿ãƒ¼ã®ä¸€è¦§è¡¨ç¤ºã€ç·¨é›†ã€å‰Šé™¤ã‚’è¡Œã„ã¾ã™ã€‚</p>
              <div class="d-grid">
                <%= link_to "ãƒ¡ãƒ³ã‚¿ãƒ¼ç®¡ç†", mentor_avatars_path, class: "btn btn-success" %>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <h3 class="card-title">ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—è¨­å®š</h3>
              <p class="card-text">ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã®æ¡ä»¶ã‚’èª¿æ•´ã—ã¾ã™ã€‚</p>
              <div class="d-grid">
                <%= link_to "ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—è¨­å®š", level_up_settings_path, class: "btn btn-warning" %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
      <div class="card mt-4">
        <div class="card-body">
          <h3 class="card-title">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³</h3>
          <div class="row">
            <div class="col-md-3">
              <h5>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°</h5>
              <p class="h2 text-primary"><%= @users.count %></p>
            </div>
            <div class="col-md-3">
              <h5>ãƒ¡ãƒ³ã‚¿ãƒ¼æ•°</h5>
              <p class="h2 text-success"><%= @mentor_avatars.count %></p>
            </div>
            <div class="col-md-3">
              <h5>ç·é–‹ç™ºæ™‚é–“</h5>
              <p class="h2 text-info"><%= (@users.sum(&:total_development_time) / 3600.0).round(2) %>æ™‚é–“</p>
            </div>
            <div class="col-md-3">
              <h5>å¹³å‡ãƒ¬ãƒ™ãƒ«</h5>
              <p class="h2 text-warning"><%= @users.any? ? (@users.sum(&:level).to_f / @users.count).round(1) : 0 %></p>
            </div>
          </div>
          
          <!-- ä¸€æ–‰ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³ -->
          <div class="mt-4 text-center">
            <h5>ä¸€æ–‰ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—</h5>
            <p class="text-muted">æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¸€æ–‰ã«ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã—ã¾ã™</p>
            
            <% level_up_candidates = @users.select(&:can_level_up?) %>
            <% if level_up_candidates.any? %>
              <div class="alert alert-warning mb-3">
                <strong>ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆ<%= level_up_candidates.count %>äººï¼‰:</strong>
                <ul class="mb-0 mt-2">
                  <% level_up_candidates.each do |user| %>
                    <li><%= user.name %>ï¼ˆç¾åœ¨ãƒ¬ãƒ™ãƒ«<%= user.level %>ï¼‰</li>
                  <% end %>
                </ul>
              </div>
            <% else %>
              <div class="alert alert-info mb-3">
                ç¾åœ¨ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“ã€‚
              </div>
            <% end %>
            
            <%= button_to "ä¸€æ–‰ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å®Ÿè¡Œ", bulk_level_up_admin_path, 
                method: :post, 
                class: "btn btn-warning btn-lg",
                disabled: level_up_candidates.empty?,
                data: { confirm: "æ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä¸€æ–‰ã«ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã—ã¾ã™ã‹ï¼Ÿ" } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<% if session[:bulk_new_mentors] %>
  <!-- ä¸€æ–‰ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—æ™‚ã®æ–°ã—ã„ãƒ¡ãƒ³ã‚¿ãƒ¼ç²å¾—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="bulk-mentor-modal" class="modal fade show" tabindex="-1" style="display: block; background: rgba(0,0,0,0.8); z-index: 9999;">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content border-0 shadow-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="modal-body text-center p-5 text-white">
          <!-- ä¸€æ–‰ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—è¡¨ç¤º -->
          <div class="level-up-badge mb-4 animate__animated animate__bounceIn">
            <div class="bg-warning text-dark px-4 py-2 rounded-pill d-inline-block">
              <h3 class="mb-0">ğŸ‰ ä¸€æ–‰ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—å®Œäº†ï¼ ğŸ‰</h3>
            </div>
          </div>
          
          <!-- æ–°ã—ã„ãƒ¡ãƒ³ã‚¿ãƒ¼ç²å¾—è€…ä¸€è¦§ -->
          <div class="new-mentors-container animate__animated animate__fadeInUp animate__delay-1s">
            <h4 class="text-warning mb-4">æ–°ã—ã„ãƒ¡ãƒ³ã‚¿ãƒ¼ã‚’ç²å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼</h4>
            <div class="row">
              <% session[:bulk_new_mentors].each do |mentor_data| %>
                <% user = User.find(mentor_data[:user_id]) %>
                <% mentor = MentorAvatar.find_by(level: mentor_data[:mentor_level]) %>
                <% if user && mentor %>
                  <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card bg-dark text-white border-warning">
                      <div class="card-body text-center">
                        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± -->
                        <h6 class="text-warning mb-2"><%= user.name %></h6>
                        <small class="text-muted">ãƒ¬ãƒ™ãƒ« <%= user.level %></small>
                        
                        <hr class="my-3">
                        
                        <!-- ãƒ¡ãƒ³ã‚¿ãƒ¼æƒ…å ± -->
                        <div class="mentor-info">
                          <% if mentor.image.attached? %>
                            <%= image_tag mentor.image, 
                                class: "img-fluid rounded-circle mb-2", 
                                style: "max-height: 80px; max-width: 80px;" %>
                          <% else %>
                            <div class="bg-light rounded-circle d-flex align-items-center justify-content-center mx-auto mb-2" 
                                 style="height: 80px; width: 80px;">
                              <span class="text-muted">ğŸ‘¨â€ğŸ’»</span>
                            </div>
                          <% end %>
                          <h6 class="mb-1"><%= mentor.name %></h6>
                          <small class="text-muted"><%= mentor.description %></small>
                          <div class="mt-2">
                            <span class="badge bg-success">ãƒ¬ãƒ™ãƒ« <%= mentor.level %></span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% end %>
            </div>
          </div>
          
          <!-- ãŠç¥ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
          <div class="celebration-message mb-4 animate__animated animate__tada animate__delay-2s">
            <h4 class="text-warning fw-bold">ğŸŠ ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ ğŸŠ</h4>
            <p class="fs-5">æ–°ã—ã„ãƒ¡ãƒ³ã‚¿ãƒ¼ã‚’ç²å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã™ï¼</p>
          </div>
          
          <!-- ã‚¨ãƒ•ã‚§ã‚¯ãƒˆçµµæ–‡å­— -->
          <div class="effects-container mb-4">
            <span class="effect-emoji" style="font-size: 2rem; animation: bounce 1s infinite;">â­</span>
            <span class="effect-emoji" style="font-size: 2rem; animation: bounce 1s infinite 0.2s;">âœ¨</span>
            <span class="effect-emoji" style="font-size: 2rem; animation: bounce 1s infinite 0.4s;">ğŸŒŸ</span>
            <span class="effect-emoji" style="font-size: 2rem; animation: bounce 1s infinite 0.6s;">ğŸ’«</span>
            <span class="effect-emoji" style="font-size: 2rem; animation: bounce 1s infinite 0.8s;">ğŸ”¥</span>
          </div>
          
          <!-- é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ -->
          <div class="modal-footer border-0 justify-content-center animate__animated animate__fadeInUp animate__delay-3s">
            <button type="button" class="btn btn-warning btn-lg px-5" onclick="closeBulkMentorModal()">
              <i class="fas fa-check me-2"></i>äº†è§£ï¼
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚«ã‚¹ã‚¿ãƒ CSS -->
  <style>
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }
    
    .effect-emoji {
      display: inline-block;
      margin: 0 5px;
    }
    
    .modal-content {
      border-radius: 20px;
    }
    
    .level-up-badge {
      transform: scale(0);
      animation: scaleIn 0.5s ease-out forwards;
    }
    
    @keyframes scaleIn {
      to { transform: scale(1); }
    }
  </style>

  <!-- JavaScript -->
  <script>
    // åŠ¹æœéŸ³ã‚’å†ç”Ÿ
    function playCelebrationSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      // è¤‡æ•°ã®éŸ³éšã§ãŠç¥ã„ã®éŸ³ã‚’å†ç”Ÿ
      const frequencies = [523.25, 659.25, 783.99, 1046.50]; // C, E, G, C
      let currentNote = 0;
      
      function playNote() {
        if (currentNote < frequencies.length) {
          oscillator.frequency.setValueAtTime(frequencies[currentNote], audioContext.currentTime);
          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
          
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.3);
          
          currentNote++;
          setTimeout(playNote, 300);
        }
      }
      
      playNote();
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeBulkMentorModal() {
      const modal = document.getElementById('bulk-mentor-modal');
      modal.classList.remove('show');
      modal.style.display = 'none';
      
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«è¡¨ç¤ºæ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ä¿å­˜
      sessionStorage.setItem('bulkMentorModalShown', 'true');
      
      // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
      window.location.reload();
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åŠ¹æœéŸ³ã‚’å†ç”Ÿ
    document.addEventListener('DOMContentLoaded', function() {
      if (document.getElementById('bulk-mentor-modal')) {
        setTimeout(playCelebrationSound, 500);
        
        // 10ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
        setTimeout(closeBulkMentorModal, 10000);
      }
    });
    
    // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeBulkMentorModal();
      }
    });
  </script>
<% end %> 