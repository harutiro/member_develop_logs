<div class="container">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ã¬ã‚‹ã½ã‚¯ãƒªãƒƒã‚«ãƒ¼</h1>
        <div>
          <%= link_to "ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹", root_path, class: "btn btn-outline-primary" %>
          <%= button_to "ãƒªã‚»ãƒƒãƒˆ", reset_nullpo_game_path, 
              method: :post, 
              class: "btn btn-outline-danger",
              data: { confirm: "æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ" },
              onclick: "resetStackedIcons();" %>
        </div>
      </div>

      <!-- ã‚²ãƒ¼ãƒ çµ±è¨ˆ -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">ã¬ã‚‹ã½æ•°</h5>
              <h2 class="text-primary" id="nullpo-count"><%= @game.formatted_nullpo_count %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">ç·ã‚¯ãƒªãƒƒã‚¯æ•°</h5>
              <h2 class="text-success" id="total-clicks"><%= @game.total_clicks %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">ã‚¯ãƒªãƒƒã‚¯åŠ›</h5>
              <h2 class="text-warning" id="click-power"><%= @game.click_power %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯</h5>
              <h2 class="text-info" id="auto-clicks"><%= @game.formatted_auto_clicks_per_second %></h2>
            </div>
          </div>
        </div>
      </div>

      <!-- ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ -->
      <div class="row">
        <div class="col-md-8">
          <div class="card">
            <div class="card-body text-center">
              <h3 class="card-title mb-4">ã¬ã‚‹ã½ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã‚ˆã†ï¼</h3>
              
              <!-- ã¬ã‚‹ã½ãƒœã‚¿ãƒ³ -->
              <div class="mb-4">
                <button id="nullpo-button" class="btn btn-lg btn-primary nullpo-button" style="font-size: 2rem; padding: 2rem 4rem; transition: all 0.2s ease; border-radius: 20px; background: linear-gradient(45deg, #007bff, #0056b3); border: none; box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);">
                  ğŸ¾ ã¬ã‚‹ã½ ğŸ¾
                </button>
              </div>

              <!-- ã¬ã‚‹ã½ã½ã•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -->
              <div id="nullpo-animation-container" style="position: relative; height: 300px; overflow: hidden; background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%); border-radius: 10px; backdrop-filter: blur(5px);">
                <!-- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¦ç´ ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                <div id="falling-container" style="position: absolute; bottom: 0; left: 0; right: 0; height: 100%; pointer-events: none;"></div>
                <div id="stack-counter" class="stack-counter" style="display: none;">ç©ã¿é‡ã­: 0å€‹</div>
              </div>

              <!-- ã‚²ãƒ¼ãƒ èª¬æ˜ -->
              <div class="alert alert-info">
                <h5>ã‚²ãƒ¼ãƒ ã®ãƒ«ãƒ¼ãƒ«</h5>
                <ul class="text-start mb-0">
                  <li><strong>ã‚¯ãƒªãƒƒã‚¯åŠ›</strong>: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦å¢—åŠ </li>
                  <li><strong>è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯</strong>: ãƒ¡ãƒ³ã‚¿ãƒ¼ã‚¢ãƒã‚¿ãƒ¼ã®ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦è‡ªå‹•ã§ã¬ã‚‹ã½ãŒå¢—åŠ </li>
                  <li><strong>ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—</strong>: é–‹ç™ºæ™‚é–“ã‚’è¨˜éŒ²ã—ã¦ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã™ã‚‹ã¨ã€ã‚¯ãƒªãƒƒã‚¯åŠ›ãŒä¸ŠãŒã‚Šã¾ã™</li>
                  <li><strong>ãƒ¡ãƒ³ã‚¿ãƒ¼å¼·åŒ–</strong>: ãƒ¡ãƒ³ã‚¿ãƒ¼ã‚¢ãƒã‚¿ãƒ¼ã‚’ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã™ã‚‹ã¨ã€è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ãŒå¼·åŒ–ã•ã‚Œã¾ã™</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± -->
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±</h5>
              <p><strong>åå‰:</strong> <%= current_user.name %></p>
              <p><strong>ãƒ¬ãƒ™ãƒ«:</strong> <span class="badge bg-primary"><%= current_user.level %></span></p>
              <p><strong>ç·é–‹ç™ºæ™‚é–“:</strong> <%= (current_user.total_development_time / 3600.0).round(2) %>æ™‚é–“</p>
              <p><strong>é”æˆæ•°:</strong> <%= current_user.achievements.count %>å€‹</p>
            </div>
          </div>

          <!-- ãƒ¡ãƒ³ã‚¿ãƒ¼æƒ…å ± -->
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">ãƒ¡ãƒ³ã‚¿ãƒ¼æƒ…å ±</h5>
              <% if current_user.current_mentor_avatar %>
                <div class="text-center mb-3">
                  <% if current_user.current_mentor_avatar.image.attached? %>
                    <%= image_tag current_user.current_mentor_avatar.image, 
                        class: "img-fluid rounded", 
                        style: "max-height: 100px;" %>
                  <% else %>
                    <div class="bg-light rounded d-flex align-items-center justify-content-center mx-auto" 
                         style="height: 100px; width: 100px;">
                      <small class="text-muted">No Image</small>
                    </div>
                  <% end %>
                </div>
                <p><strong>åå‰:</strong> <%= current_user.current_mentor_avatar.name %></p>
                <p><strong>ãƒ¬ãƒ™ãƒ«:</strong> <span class="badge bg-success"><%= current_user.current_mentor_avatar.level %></span></p>
                <p><strong>è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯åŠ›:</strong> <%= current_user.current_mentor_avatar.level * 2 %>/ç§’</p>
              <% else %>
                <p class="text-muted">ãƒ¡ãƒ³ã‚¿ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const nullpoButton = document.getElementById('nullpo-button');
  const nullpoCount = document.getElementById('nullpo-count');
  const totalClicks = document.getElementById('total-clicks');
  const clickPower = document.getElementById('click-power');
  const autoClicks = document.getElementById('auto-clicks');
  const animationContainer = document.getElementById('nullpo-animation-container');
  const fallingContainer = document.getElementById('falling-container');
  const stackCounter = document.getElementById('stack-counter');

  // ç©ã¿é‡ã­ã‚‰ã‚ŒãŸã‚¢ã‚¤ã‚³ãƒ³ã®ç®¡ç†
  let stackedIcons = [];
  const containerWidth = 400; // ã‚³ãƒ³ãƒ†ãƒŠã®å¹…
  const iconSize = 30; // ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚µã‚¤ã‚º
  const gravity = 0.5; // é‡åŠ›åŠ é€Ÿåº¦
  const bounce = 0.7; // è·³ã­è¿”ã‚Šä¿‚æ•°
  const friction = 0.98; // æ‘©æ“¦ä¿‚æ•°

  // è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ã®çŠ¶æ…‹ç®¡ç†
  let lastAutoClickCount = 0;
  let autoClickAnimationInterval = null;

  console.log('ã¬ã‚‹ã½ã‚²ãƒ¼ãƒ åˆæœŸåŒ–å®Œäº†');
  console.log('CSRFãƒˆãƒ¼ã‚¯ãƒ³:', document.querySelector('meta[name="csrf-token"]')?.content);
  console.log('ã‚¯ãƒªãƒƒã‚¯URL:', '<%= click_nullpo_game_path %>');
  console.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹URL:', '<%= status_nullpo_game_path %>');

  // åŠ¹æœéŸ³ã®è¨­å®š
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  
  function playClickSound() {
    try {
      // ãƒ©ãƒ³ãƒ€ãƒ ãªåŠ¹æœéŸ³ã‚’é¸æŠ
      const sounds = [
        { freq: [800, 1200], duration: 0.1 }, // é«˜éŸ³ãƒ”ãƒƒãƒ—
        { freq: [600, 900], duration: 0.15 }, // ä¸­éŸ³ãƒ”ãƒƒãƒ—
        { freq: [400, 700], duration: 0.12 }, // ä½éŸ³ãƒ”ãƒƒãƒ—
        { freq: [1000, 1500, 1200], duration: 0.2 }, // 3éŸ³éš
        { freq: [500, 800, 1100], duration: 0.18 } // ä¸Šæ˜‡éŸ³éš
      ];
      
      const selectedSound = sounds[Math.floor(Math.random() * sounds.length)];
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      // è¤‡æ•°ã®å‘¨æ³¢æ•°ãŒã‚ã‚‹å ´åˆã¯éŸ³éšã‚’ä½œæˆ
      if (selectedSound.freq.length === 2) {
        oscillator.frequency.setValueAtTime(selectedSound.freq[0], audioContext.currentTime);
        oscillator.frequency.exponentialRampToValueAtTime(selectedSound.freq[1], audioContext.currentTime + selectedSound.duration);
      } else if (selectedSound.freq.length === 3) {
        oscillator.frequency.setValueAtTime(selectedSound.freq[0], audioContext.currentTime);
        oscillator.frequency.setValueAtTime(selectedSound.freq[1], audioContext.currentTime + selectedSound.duration * 0.5);
        oscillator.frequency.setValueAtTime(selectedSound.freq[2], audioContext.currentTime + selectedSound.duration);
      }
      
      gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + selectedSound.duration);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + selectedSound.duration);
    } catch (error) {
      console.log('åŠ¹æœéŸ³å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
    }
  }

  // ã¬ã‚‹ã½ã½ã•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  function createNullpoAnimation(x, y) {
    const nullpoEmojis = ['ğŸ¾', 'âœ¨', 'ğŸ’«', 'ğŸŒŸ', 'â­', 'ğŸ’¥', 'ğŸ”¥', 'ğŸ’', 'ğŸ‰', 'ğŸŠ', 'ğŸˆ', 'ğŸª', 'ğŸŒˆ', 'ğŸš€', 'âš¡', 'ğŸ’–', 'ğŸ¯', 'ğŸ¨', 'ğŸ­', 'ğŸª'];
    const randomEmoji = nullpoEmojis[Math.floor(Math.random() * nullpoEmojis.length)];
    
    // è½ä¸‹ã™ã‚‹ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½œæˆ
    createFallingIcon(x, y, randomEmoji);
    
    // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    createParticleExplosion(x, y);
    
    // æ³¢ç´‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    createRippleEffect(x, y);
    
    // è¤‡æ•°ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¦ç´ ã‚’ä½œæˆï¼ˆãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ï¼‰
    for (let i = 0; i < 3; i++) {
      setTimeout(() => {
        const extraEmoji = nullpoEmojis[Math.floor(Math.random() * nullpoEmojis.length)];
        const offsetX = (Math.random() - 0.5) * 100;
        const offsetY = (Math.random() - 0.5) * 50;
        createFallingIcon(x + offsetX, y + offsetY, extraEmoji);
      }, i * 100);
    }
  }

  // è½ä¸‹ã™ã‚‹ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½œæˆ
  function createFallingIcon(x, y, emoji, isAutoClick = false) {
    const icon = document.createElement('div');
    icon.innerHTML = emoji;
    const iconSizeToUse = isAutoClick ? iconSize * 0.7 : iconSize; // è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ç”¨ã¯å°ã•ã‚
    
    icon.style.cssText = `
      position: absolute;
      left: ${x}px;
      top: ${y}px;
      font-size: ${iconSizeToUse}px;
      pointer-events: none;
      z-index: 1000;
      transform: rotate(${Math.random() * 360}deg);
      filter: hue-rotate(${Math.random() * 360}deg);
      transition: none;
      opacity: ${isAutoClick ? 0.8 : 1}; // è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ç”¨ã¯å°‘ã—é€æ˜
    `;
    
    fallingContainer.appendChild(icon);
    
    // ç‰©ç†æ¼”ç®—ã®åˆæœŸå€¤
    const physics = {
      x: x,
      y: y,
      vx: (Math.random() - 0.5) * (isAutoClick ? 1 : 2), // è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ç”¨ã¯é€Ÿåº¦ã‚’æŠ‘ãˆã‚‹
      vy: 0,
      rotation: Math.random() * 360,
      rotationSpeed: (Math.random() - 0.5) * (isAutoClick ? 5 : 10), // è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ç”¨ã¯å›è»¢ã‚’æŠ‘ãˆã‚‹
      settled: false,
      isAutoClick: isAutoClick
    };
    
    stackedIcons.push({ element: icon, physics: physics });
  }

  // ç‰©ç†æ¼”ç®—ã®æ›´æ–°
  function updatePhysics() {
    stackedIcons.forEach((iconData, index) => {
      const { element, physics } = iconData;
      
      if (physics.settled) return;
      
      // ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚µã‚¤ã‚ºã‚’å–å¾—
      const currentIconSize = physics.isAutoClick ? iconSize * 0.7 : iconSize;
      
      // é‡åŠ›ã‚’é©ç”¨
      physics.vy += gravity;
      
      // é€Ÿåº¦ã‚’æ›´æ–°
      physics.x += physics.vx;
      physics.y += physics.vy;
      
      // å›è»¢ã‚’æ›´æ–°
      physics.rotation += physics.rotationSpeed;
      
      // æ‘©æ“¦ã‚’é©ç”¨
      physics.vx *= friction;
      physics.rotationSpeed *= friction;
      
      // åœ°é¢ã¨ã®è¡çªåˆ¤å®š
      const containerHeight = fallingContainer.offsetHeight;
      const groundY = containerHeight - currentIconSize;
      
      if (physics.y >= groundY) {
        physics.y = groundY;
        physics.vy = -physics.vy * bounce;
        
        // é€Ÿåº¦ãŒå°ã•ããªã£ãŸã‚‰åœæ­¢
        if (Math.abs(physics.vy) < 1) {
          physics.vy = 0;
          physics.vx = 0;
          physics.rotationSpeed = 0;
          physics.settled = true;
        }
      }
      
      // å·¦å³ã®å£ã¨ã®è¡çªåˆ¤å®š
      if (physics.x <= 0 || physics.x >= containerWidth - currentIconSize) {
        physics.vx = -physics.vx * bounce;
        physics.x = Math.max(0, Math.min(containerWidth - currentIconSize, physics.x));
      }
      
      // ä»–ã®ã‚¢ã‚¤ã‚³ãƒ³ã¨ã®è¡çªåˆ¤å®š
      stackedIcons.forEach((otherIconData, otherIndex) => {
        if (index === otherIndex || !otherIconData.physics.settled) return;
        
        const otherIconSize = otherIconData.physics.isAutoClick ? iconSize * 0.7 : iconSize;
        const dx = physics.x - otherIconData.physics.x;
        const dy = physics.y - otherIconData.physics.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        const collisionDistance = (currentIconSize + otherIconSize) / 2;
        
        if (distance < collisionDistance) {
          // è¡çªå‡¦ç†
          const overlap = collisionDistance - distance;
          const angle = Math.atan2(dy, dx);
          
          physics.x += Math.cos(angle) * overlap * 0.5;
          physics.y += Math.sin(angle) * overlap * 0.5;
          
          // é€Ÿåº¦ã‚’åè»¢
          physics.vx = -physics.vx * bounce;
          physics.vy = -physics.vy * bounce;
        }
      });
      
      // è¦ç´ ã®ä½ç½®ã‚’æ›´æ–°
      element.style.left = `${physics.x}px`;
      element.style.top = `${physics.y}px`;
      element.style.transform = `rotate(${physics.rotation}deg)`;
    });
  }

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
  function animationLoop() {
    updatePhysics();
    updateStackCounter();
    requestAnimationFrame(animationLoop);
  }

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
  animationLoop();

  // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
  function addButtonEffect() {
    nullpoButton.style.transform = 'scale(0.9)';
    nullpoButton.style.boxShadow = '0 0 30px rgba(0, 123, 255, 0.9)';
    nullpoButton.style.filter = 'brightness(1.2) hue-rotate(30deg)';
    
    // ãƒœã‚¿ãƒ³ã«ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
    addSparkleEffect();
    
    setTimeout(() => {
      nullpoButton.style.transform = 'scale(1)';
      nullpoButton.style.boxShadow = '';
      nullpoButton.style.filter = '';
    }, 150);
  }

  // ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
  function addSparkleEffect() {
    const sparkles = ['âœ¨', 'ğŸ’«', 'â­', 'ğŸŒŸ'];
    const buttonRect = nullpoButton.getBoundingClientRect();
    
    for (let i = 0; i < 8; i++) {
      setTimeout(() => {
        const sparkle = document.createElement('div');
        sparkle.innerHTML = sparkles[Math.floor(Math.random() * sparkles.length)];
        sparkle.style.cssText = `
          position: fixed;
          left: ${buttonRect.left + Math.random() * buttonRect.width}px;
          top: ${buttonRect.top + Math.random() * buttonRect.height}px;
          font-size: ${1 + Math.random() * 1}rem;
          pointer-events: none;
          z-index: 1001;
          animation: sparkleEffect 0.8s ease-out forwards;
          transform: translate(-50%, -50%);
        `;
        
        document.body.appendChild(sparkle);
        
        setTimeout(() => {
          if (sparkle.parentNode) {
            sparkle.parentNode.removeChild(sparkle);
          }
        }, 800);
      }, i * 50);
    }
  }

  // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  function updateGameStatus() {
    fetch('<%= status_nullpo_game_path %>', {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        // è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ã®å¢—åŠ ã‚’æ¤œå‡ºã—ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†ç”Ÿ
        const currentAutoClicks = parseInt(data.auto_clicks_per_second) || 0;
        const autoClickIncrease = currentAutoClicks - lastAutoClickCount;
        
        if (autoClickIncrease > 0) {
          // è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ãŒå¢—åŠ ã—ãŸå ´åˆã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†ç”Ÿ
          for (let i = 0; i < Math.min(autoClickIncrease, 5); i++) { // æœ€å¤§5å›ã¾ã§
            setTimeout(() => {
              createAutoClickAnimation();
            }, i * 100);
          }
        }
        
        lastAutoClickCount = currentAutoClicks;
        
        nullpoCount.textContent = data.nullpo_count;
        totalClicks.textContent = data.total_clicks;
        clickPower.textContent = data.click_power;
        autoClicks.textContent = data.auto_clicks_per_second;
      } else {
        console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', data.error);
      }
    })
    .catch(error => {
      console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    });
  }

  // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
  nullpoButton.addEventListener('click', function(event) {
    console.log('ã¬ã‚‹ã½ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
    
    // åŠ¹æœéŸ³ã‚’å†ç”Ÿ
    playClickSound();
    
    // ãƒœã‚¿ãƒ³ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    addButtonEffect();
    
    // ç”»é¢æºã‚ŒåŠ¹æœ
    addScreenShake();
    
    // ã¬ã‚‹ã½ã½ã•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const rect = nullpoButton.getBoundingClientRect();
    const containerRect = animationContainer.getBoundingClientRect();
    const x = rect.left - containerRect.left + rect.width / 2;
    const y = rect.top - containerRect.top;
    createNullpoAnimation(x, y);
    
    // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
    nullpoButton.disabled = true;
    nullpoButton.textContent = 'ğŸ¾ ã‚¯ãƒªãƒƒã‚¯ä¸­... ğŸ¾';
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    if (!csrfToken) {
      console.error('CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      alert('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
      nullpoButton.disabled = false;
      nullpoButton.textContent = 'ğŸ¾ ã¬ã‚‹ã½ ğŸ¾';
      return;
    }
    
    fetch('<%= click_nullpo_game_path %>', {
      method: 'POST',
      headers: {
        'X-CSRF-Token': csrfToken,
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }
    })
    .then(response => {
      console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status, response.statusText);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('ãƒ‡ãƒ¼ã‚¿å—ä¿¡:', data);
      if (data.success) {
        // ã‚¯ãƒªãƒƒã‚¯å¾Œã«å³åº§ã«çŠ¶æ…‹ã‚’æ›´æ–°
        updateGameStatus();
      } else {
        throw new Error(data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
      
      // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      nullpoButton.disabled = false;
      nullpoButton.textContent = 'ğŸ¾ ã¬ã‚‹ã½ ğŸ¾';
    })
    .catch(error => {
      console.error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
      alert('ã‚¯ãƒªãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      
      // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      nullpoButton.disabled = false;
      nullpoButton.textContent = 'ğŸ¾ ã¬ã‚‹ã½ ğŸ¾';
    });
  });

  // ç”»é¢æºã‚ŒåŠ¹æœ
  function addScreenShake() {
    const container = document.querySelector('.container');
    const originalTransform = container.style.transform;
    
    // æºã‚Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    const shakeAnimation = [
      { transform: 'translateX(0px)' },
      { transform: 'translateX(-5px)' },
      { transform: 'translateX(5px)' },
      { transform: 'translateX(-3px)' },
      { transform: 'translateX(3px)' },
      { transform: 'translateX(-1px)' },
      { transform: 'translateX(1px)' },
      { transform: 'translateX(0px)' }
    ];
    
    container.animate(shakeAnimation, {
      duration: 300,
      easing: 'ease-in-out'
    });
  }

  // è‡ªå‹•æ›´æ–°ï¼ˆ1ç§’ã”ã¨ï¼‰
  setInterval(function() {
    console.log('è‡ªå‹•æ›´æ–°å®Ÿè¡Œ');
    updateGameStatus();
  }, 1000);

  // è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®å®šæœŸå®Ÿè¡Œ
  setInterval(function() {
    const currentAutoClicks = parseInt(autoClicks.textContent) || 0;
    if (currentAutoClicks > 0) {
      // è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ãŒæœ‰åŠ¹ãªå ´åˆã€ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†ç”Ÿ
      if (Math.random() < 0.3) { // 30%ã®ç¢ºç‡ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        createAutoClickAnimation();
      }
    }
  }, 2000); // 2ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯

  // åˆæœŸçŠ¶æ…‹ã‚’å–å¾—
  updateGameStatus();

  // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
  function createParticleExplosion(x, y) {
    const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff', '#5f27cd'];
    
    for (let i = 0; i < 8; i++) {
      const particle = document.createElement('div');
      const angle = (i / 8) * 2 * Math.PI;
      const distance = 30 + Math.random() * 50;
      const endX = Math.cos(angle) * distance;
      const endY = Math.sin(angle) * distance;
      
      particle.style.cssText = `
        position: absolute;
        left: ${x}px;
        top: ${y}px;
        width: ${3 + Math.random() * 6}px;
        height: ${3 + Math.random() * 6}px;
        background: ${colors[Math.floor(Math.random() * colors.length)]};
        border-radius: 50%;
        pointer-events: none;
        z-index: 999;
        transform: translate(-50%, -50%);
      `;
      
      // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      particle.animate([
        { 
          transform: 'translate(-50%, -50%) scale(0) rotate(0deg)',
          opacity: 1
        },
        { 
          transform: `translate(calc(-50% + ${endX * 0.5}px), calc(-50% + ${endY * 0.5}px)) scale(1) rotate(180deg)`,
          opacity: 0.8
        },
        { 
          transform: `translate(calc(-50% + ${endX}px), calc(-50% + ${endY}px)) scale(0) rotate(360deg)`,
          opacity: 0
        }
      ], {
        duration: 800,
        easing: 'ease-out'
      });
      
      animationContainer.appendChild(particle);
      
      setTimeout(() => {
        if (particle.parentNode) {
          particle.parentNode.removeChild(particle);
        }
      }, 800);
    }
  }

  // æ³¢ç´‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
  function createRippleEffect(x, y) {
    for (let i = 0; i < 2; i++) {
      setTimeout(() => {
        const ripple = document.createElement('div');
        ripple.style.cssText = `
          position: absolute;
          left: ${x}px;
          top: ${y}px;
          width: 15px;
          height: 15px;
          border: 2px solid rgba(0, 123, 255, 0.6);
          border-radius: 50%;
          pointer-events: none;
          z-index: 998;
          animation: rippleEffect 0.8s ease-out forwards;
          transform: translate(-50%, -50%);
        `;
        
        animationContainer.appendChild(ripple);
        
        setTimeout(() => {
          if (ripple.parentNode) {
            ripple.parentNode.removeChild(ripple);
          }
        }, 800);
      }, i * 150);
    }
  }

  // ç©ã¿é‡ã­ã‚‰ã‚ŒãŸã‚¢ã‚¤ã‚³ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
  function resetStackedIcons() {
    stackedIcons.forEach(iconData => {
      if (iconData.element.parentNode) {
        iconData.element.parentNode.removeChild(iconData.element);
      }
    });
    stackedIcons = [];
    updateStackCounter();
  }

  // ç©ã¿é‡ã­ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’æ›´æ–°
  function updateStackCounter() {
    const settledCount = stackedIcons.filter(iconData => iconData.physics.settled).length;
    if (settledCount > 0) {
      stackCounter.textContent = `ç©ã¿é‡ã­: ${settledCount}å€‹`;
      stackCounter.style.display = 'block';
    } else {
      stackCounter.style.display = 'none';
    }
  }

  // è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  function createAutoClickAnimation() {
    const containerRect = animationContainer.getBoundingClientRect();
    const x = Math.random() * (containerRect.width - 50) + 25;
    const y = Math.random() * (containerRect.height * 0.3) + 10; // ä¸Šéƒ¨30%ã®ç¯„å›²ã§ãƒ©ãƒ³ãƒ€ãƒ 
    
    // è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ç”¨ã®è»½ã„ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    createAutoClickNullpoAnimation(x, y);
  }

  // è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ç”¨ã®ã¬ã‚‹ã½ã½ã•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè»½é‡ç‰ˆï¼‰
  function createAutoClickNullpoAnimation(x, y) {
    const nullpoEmojis = ['âœ¨', 'ğŸ’«', 'â­', 'ğŸŒŸ', 'ğŸ’', 'ğŸ‰', 'ğŸŠ', 'ğŸˆ', 'ğŸŒˆ', 'ğŸš€', 'âš¡', 'ğŸ’–'];
    const randomEmoji = nullpoEmojis[Math.floor(Math.random() * nullpoEmojis.length)];
    
    // è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ç”¨ã®å°ã•ã‚ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½œæˆ
    createFallingIcon(x, y, randomEmoji, true);
    
    // è»½é‡ãªãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    createLightParticleExplosion(x, y);
    
    // è»½é‡ãªæ³¢ç´‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    createLightRippleEffect(x, y);
  }

  // è»½é‡ãªãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
  function createLightParticleExplosion(x, y) {
    const colors = ['#4ecdc4', '#45b7d1', '#96ceb4', '#feca57'];
    
    for (let i = 0; i < 4; i++) {
      const particle = document.createElement('div');
      const angle = (i / 4) * 2 * Math.PI;
      const distance = 20 + Math.random() * 30;
      const endX = Math.cos(angle) * distance;
      const endY = Math.sin(angle) * distance;
      
      particle.style.cssText = `
        position: absolute;
        left: ${x}px;
        top: ${y}px;
        width: ${2 + Math.random() * 4}px;
        height: ${2 + Math.random() * 4}px;
        background: ${colors[Math.floor(Math.random() * colors.length)]};
        border-radius: 50%;
        pointer-events: none;
        z-index: 999;
        transform: translate(-50%, -50%);
      `;
      
      // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      particle.animate([
        { 
          transform: 'translate(-50%, -50%) scale(0) rotate(0deg)',
          opacity: 0.8
        },
        { 
          transform: `translate(calc(-50% + ${endX * 0.5}px), calc(-50% + ${endY * 0.5}px)) scale(1) rotate(180deg)`,
          opacity: 0.6
        },
        { 
          transform: `translate(calc(-50% + ${endX}px), calc(-50% + ${endY}px)) scale(0) rotate(360deg)`,
          opacity: 0
        }
      ], {
        duration: 600,
        easing: 'ease-out'
      });
      
      animationContainer.appendChild(particle);
      
      setTimeout(() => {
        if (particle.parentNode) {
          particle.parentNode.removeChild(particle);
        }
      }, 600);
    }
  }

  // è»½é‡ãªæ³¢ç´‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
  function createLightRippleEffect(x, y) {
    const ripple = document.createElement('div');
    ripple.style.cssText = `
      position: absolute;
      left: ${x}px;
      top: ${y}px;
      width: 10px;
      height: 10px;
      border: 1px solid rgba(0, 123, 255, 0.4);
      border-radius: 50%;
      pointer-events: none;
      z-index: 998;
      animation: rippleEffect 0.6s ease-out forwards;
      transform: translate(-50%, -50%);
    `;
    
    animationContainer.appendChild(ripple);
    
    setTimeout(() => {
      if (ripple.parentNode) {
        ripple.parentNode.removeChild(ripple);
      }
    }, 600);
  }
});
</script>

<style>
@keyframes nullpoFloat {
  0% {
    transform: translateY(0) scale(1) rotate(0deg);
    opacity: 1;
  }
  25% {
    transform: translateY(-25px) scale(1.1) rotate(90deg);
    opacity: 0.9;
  }
  50% {
    transform: translateY(-50px) scale(1.2) rotate(180deg);
    opacity: 0.8;
  }
  75% {
    transform: translateY(-75px) scale(1.1) rotate(270deg);
    opacity: 0.6;
  }
  100% {
    transform: translateY(-100px) scale(0.8) rotate(360deg);
    opacity: 0;
  }
}

@keyframes nullpoFloatExtra {
  0% {
    transform: translateY(0) scale(0.8) rotate(0deg);
    opacity: 0.8;
  }
  50% {
    transform: translateY(-30px) scale(1.1) rotate(180deg);
    opacity: 0.6;
  }
  100% {
    transform: translateY(-60px) scale(0.6) rotate(360deg);
    opacity: 0;
  }
}

@keyframes rippleEffect {
  0% {
    transform: translate(-50%, -50%) scale(0);
    opacity: 1;
    border-width: 2px;
  }
  100% {
    transform: translate(-50%, -50%) scale(3);
    opacity: 0;
    border-width: 1px;
  }
}

@keyframes sparkleEffect {
  0% {
    transform: translate(-50%, -50%) scale(0) rotate(0deg);
    opacity: 1;
  }
  50% {
    transform: translate(-50%, -50%) scale(1.2) rotate(180deg);
    opacity: 0.8;
  }
  100% {
    transform: translate(-50%, -50%) scale(0) rotate(360deg);
    opacity: 0;
  }
}

.nullpo-button:hover {
  transform: scale(1.08) translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 123, 255, 0.4);
  background: linear-gradient(45deg, #0056b3, #004085) !important;
  transition: all 0.3s ease;
}

.nullpo-button:active {
  transform: scale(0.95) translateY(1px);
  box-shadow: 0 2px 10px rgba(0, 123, 255, 0.3);
  transition: all 0.1s ease;
}

/* ã¬ã‚‹ã½ã½ã•ã®è¿½åŠ ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
.nullpo-button.clicked {
  animation: nullpoClick 0.3s ease-out;
}

@keyframes nullpoClick {
  0% {
    transform: scale(1);
  }
  50% {
    transform: scale(0.9);
  }
  100% {
    transform: scale(1);
  }
}

/* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
.particle {
  position: absolute;
  pointer-events: none;
  animation: particleFloat 2s ease-out forwards;
}

@keyframes particleFloat {
  0% {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
  100% {
    transform: translateY(-150px) scale(0);
    opacity: 0;
  }
}

/* ã¬ã‚‹ã½ã½ã•ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
#nullpo-animation-container {
  background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
  border-radius: 10px;
  backdrop-filter: blur(5px);
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.1);
}

/* è¿½åŠ ã®è¦–è¦šåŠ¹æœ */
#nullpo-animation-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: radial-gradient(circle at center, rgba(255,255,255,0.1) 0%, transparent 70%);
  pointer-events: none;
  z-index: 1;
}

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¦ç´ ã®z-indexèª¿æ•´ */
#nullpo-animation-container > div {
  z-index: 2;
}

/* ç©ã¿é‡ã­ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
#falling-container {
  background: linear-gradient(to bottom, transparent 0%, rgba(255,255,255,0.05) 100%);
  border-radius: 0 0 10px 10px;
}

/* è½ä¸‹ã™ã‚‹ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
#falling-container > div {
  will-change: transform;
  backface-visibility: hidden;
  transform-style: preserve-3d;
}

/* ç©ã¿é‡ã­åŠ¹æœã®å½± */
#falling-container > div {
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
}

/* ç©ã¿é‡ã­ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¡¨ç¤º */
.stack-counter {
  position: absolute;
  top: 10px;
  right: 10px;
  background: rgba(0, 123, 255, 0.8);
  color: white;
  padding: 5px 10px;
  border-radius: 15px;
  font-size: 0.8rem;
  z-index: 1000;
}
</style> 