<div class="container">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>ã¬ã‚‹ã½ã‚¯ãƒªãƒƒã‚«ãƒ¼</h1>
        <div>
          <%= link_to "ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹", root_path, class: "btn btn-outline-primary" %>
          <%= button_to "ãƒªã‚»ãƒƒãƒˆ", reset_nullpo_game_path, 
              method: :post, 
              class: "btn btn-outline-danger",
              data: { confirm: "æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ" } %>
        </div>
      </div>

      <!-- ã‚²ãƒ¼ãƒ çµ±è¨ˆ -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">ã¬ã‚‹ã½æ•°</h5>
              <h2 class="text-primary" id="nullpo-count"><%= @game.formatted_nullpo_count %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">ç·ã‚¯ãƒªãƒƒã‚¯æ•°</h5>
              <h2 class="text-success" id="total-clicks"><%= @game.total_clicks %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">ã‚¯ãƒªãƒƒã‚¯åŠ›</h5>
              <h2 class="text-warning" id="click-power"><%= @game.click_power %></h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title">è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯</h5>
              <h2 class="text-info" id="auto-clicks"><%= @game.formatted_auto_clicks_per_second %></h2>
            </div>
          </div>
        </div>
      </div>

      <!-- ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ -->
      <div class="row">
        <div class="col-md-8">
          <div class="card">
            <div class="card-body text-center">
              <h3 class="card-title mb-4">ã¬ã‚‹ã½ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã‚ˆã†ï¼</h3>
              
              <!-- ã¬ã‚‹ã½ãƒœã‚¿ãƒ³ -->
              <div class="mb-4">
                <button id="nullpo-button" class="btn btn-lg btn-primary" style="font-size: 2rem; padding: 2rem 4rem;">
                  ğŸ¾ ã¬ã‚‹ã½ ğŸ¾
                </button>
              </div>

              <!-- ã‚²ãƒ¼ãƒ èª¬æ˜ -->
              <div class="alert alert-info">
                <h5>ã‚²ãƒ¼ãƒ ã®ãƒ«ãƒ¼ãƒ«</h5>
                <ul class="text-start mb-0">
                  <li><strong>ã‚¯ãƒªãƒƒã‚¯åŠ›</strong>: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦å¢—åŠ </li>
                  <li><strong>è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯</strong>: ãƒ¡ãƒ³ã‚¿ãƒ¼ã‚¢ãƒã‚¿ãƒ¼ã®ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦è‡ªå‹•ã§ã¬ã‚‹ã½ãŒå¢—åŠ </li>
                  <li><strong>ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—</strong>: é–‹ç™ºæ™‚é–“ã‚’è¨˜éŒ²ã—ã¦ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã™ã‚‹ã¨ã€ã‚¯ãƒªãƒƒã‚¯åŠ›ãŒä¸ŠãŒã‚Šã¾ã™</li>
                  <li><strong>ãƒ¡ãƒ³ã‚¿ãƒ¼å¼·åŒ–</strong>: ãƒ¡ãƒ³ã‚¿ãƒ¼ã‚¢ãƒã‚¿ãƒ¼ã‚’ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã™ã‚‹ã¨ã€è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯ãŒå¼·åŒ–ã•ã‚Œã¾ã™</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ± -->
          <div class="card mb-4">
            <div class="card-body">
              <h5 class="card-title">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±</h5>
              <p><strong>åå‰:</strong> <%= current_user.name %></p>
              <p><strong>ãƒ¬ãƒ™ãƒ«:</strong> <span class="badge bg-primary"><%= current_user.level %></span></p>
              <p><strong>ç·é–‹ç™ºæ™‚é–“:</strong> <%= (current_user.total_development_time / 3600.0).round(2) %>æ™‚é–“</p>
              <p><strong>é”æˆæ•°:</strong> <%= current_user.achievements.count %>å€‹</p>
            </div>
          </div>

          <!-- ãƒ¡ãƒ³ã‚¿ãƒ¼æƒ…å ± -->
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">ãƒ¡ãƒ³ã‚¿ãƒ¼æƒ…å ±</h5>
              <% if current_user.current_mentor_avatar %>
                <div class="text-center mb-3">
                  <% if current_user.current_mentor_avatar.image.attached? %>
                    <%= image_tag current_user.current_mentor_avatar.image, 
                        class: "img-fluid rounded", 
                        style: "max-height: 100px;" %>
                  <% else %>
                    <div class="bg-light rounded d-flex align-items-center justify-content-center mx-auto" 
                         style="height: 100px; width: 100px;">
                      <small class="text-muted">No Image</small>
                    </div>
                  <% end %>
                </div>
                <p><strong>åå‰:</strong> <%= current_user.current_mentor_avatar.name %></p>
                <p><strong>ãƒ¬ãƒ™ãƒ«:</strong> <span class="badge bg-success"><%= current_user.current_mentor_avatar.level %></span></p>
                <p><strong>è‡ªå‹•ã‚¯ãƒªãƒƒã‚¯åŠ›:</strong> <%= current_user.current_mentor_avatar.level * 2 %>/ç§’</p>
              <% else %>
                <p class="text-muted">ãƒ¡ãƒ³ã‚¿ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const nullpoButton = document.getElementById('nullpo-button');
  const nullpoCount = document.getElementById('nullpo-count');
  const totalClicks = document.getElementById('total-clicks');
  const clickPower = document.getElementById('click-power');
  const autoClicks = document.getElementById('auto-clicks');

  console.log('ã¬ã‚‹ã½ã‚²ãƒ¼ãƒ åˆæœŸåŒ–å®Œäº†');
  console.log('CSRFãƒˆãƒ¼ã‚¯ãƒ³:', document.querySelector('meta[name="csrf-token"]')?.content);
  console.log('ã‚¯ãƒªãƒƒã‚¯URL:', '<%= click_nullpo_game_path %>');
  console.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹URL:', '<%= status_nullpo_game_path %>');

  // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  function updateGameStatus() {
    fetch('<%= status_nullpo_game_path %>', {
      method: 'GET',
      headers: {
        'Accept': 'application/json'
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      if (data.success) {
        nullpoCount.textContent = data.nullpo_count;
        totalClicks.textContent = data.total_clicks;
        clickPower.textContent = data.click_power;
        autoClicks.textContent = data.auto_clicks_per_second;
      } else {
        console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', data.error);
      }
    })
    .catch(error => {
      console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    });
  }

  // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
  nullpoButton.addEventListener('click', function() {
    console.log('ã¬ã‚‹ã½ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
    
    // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
    nullpoButton.disabled = true;
    nullpoButton.textContent = 'ğŸ¾ ã‚¯ãƒªãƒƒã‚¯ä¸­... ğŸ¾';
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    if (!csrfToken) {
      console.error('CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      alert('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
      nullpoButton.disabled = false;
      nullpoButton.textContent = 'ğŸ¾ ã¬ã‚‹ã½ ğŸ¾';
      return;
    }
    
    fetch('<%= click_nullpo_game_path %>', {
      method: 'POST',
      headers: {
        'X-CSRF-Token': csrfToken,
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      }
    })
    .then(response => {
      console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹å—ä¿¡:', response.status, response.statusText);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('ãƒ‡ãƒ¼ã‚¿å—ä¿¡:', data);
      if (data.success) {
        // ã‚¯ãƒªãƒƒã‚¯å¾Œã«å³åº§ã«çŠ¶æ…‹ã‚’æ›´æ–°
        updateGameStatus();
      } else {
        throw new Error(data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
      
      // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      nullpoButton.disabled = false;
      nullpoButton.textContent = 'ğŸ¾ ã¬ã‚‹ã½ ğŸ¾';
    })
    .catch(error => {
      console.error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
      alert('ã‚¯ãƒªãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      
      // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      nullpoButton.disabled = false;
      nullpoButton.textContent = 'ğŸ¾ ã¬ã‚‹ã½ ğŸ¾';
    });
  });

  // è‡ªå‹•æ›´æ–°ï¼ˆ1ç§’ã”ã¨ï¼‰
  setInterval(function() {
    console.log('è‡ªå‹•æ›´æ–°å®Ÿè¡Œ');
    updateGameStatus();
  }, 1000);

  // åˆæœŸçŠ¶æ…‹ã‚’å–å¾—
  updateGameStatus();
});
</script> 